language: php
sudo: false

php:
  - 5.4
  - 5.5
  - 5.6
  - 7.0
  - 7.1
  - 7.2
  - 7.3
  - 7.4snapshot
  - nightly
  - hhvm
  - hhvm-nightly

matrix:
  allow_failures:
    - php: hhvm
    - php: hhvm-nightly
    - php: 7.4snapshot
    - php: nightly

before_script:
  - git fetch --unshallow --tags
  - composer install --prefer-source
  - curl -LSs https://box-project.github.io/box2/installer.php | php
  - wget https://scrutinizer-ci.com/ocular.phar

script:
  - php vendor/atoum/atoum/scripts/coverage.php --format xml --output clover.xml
  - composer install --no-dev --optimize-autoloader
  - php box.phar build
  - composer install
  - PICKLE_BEHAT_PROCESS_TIMEOUT=0 vendor/bin/behat --format=progress

after_script:
  - php ocular.phar code-coverage:upload --format=php-clover clover.xml

deploy:
  provider: releases
  api_key:
    secure: S5zmtkDizyJpPIVpJeTuLpLC4/AM5SILXR37wbdIo5GY2yWIdDDZqZ19J5cy0SmqSuYjdYjg8XHQtv0CsZv8gxQX120o/ODwzAtUlPb0PyTvIU2fKaHw8Dcj4ZP/NC9DIItwUYP1JfxubP1sKWPl/GUiZr4HB2ufhUEShWbX0q0=
  file: pickle.phar
  skip_cleanup: true
  on:
    tags: true
    repo: FriendsOfPHP/pickle

cache:
  directories:
  - $HOME/.composer/cache
